<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../css/teste.css" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <!-- <script src="avion_menu.js"></script> -->
</head>
<body onload="onLoaderFunc()">

<div class="inputForm">
    <center>
        Nombre *: <input type="text" id="Username" required>
        Numero de Asientos *: <input type="number" id="Numseats" required>
        <br /><br />
        <button onclick="takeData()">Seleccione</button>
    </center>
</div>

<div class="seatStructure">
    <center>

        <table id="seatsBlock">
            <p id="notification"></p>
            <tr>
                <td colspan="14">
                    <div class="screen">Avion</div>
                </td>
                <td rowspan="20">
                    <div class="smallBox greenBox">Asiento Seleccionado</div> <br />
                    <div class="smallBox redBox">Asiento Reservado</div><br />
                    <div class="smallBox emptyBox">Asiento Vacio</div><br />
                </td>

                <br />
            </tr>

            <tr>
                <td></td>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td></td>
                <td>6</td>
                <td>7</td>
                <td>8</td>
                <td>9</td>
                <td>10</td>
                <td>11</td>
                <td>12</td>
            </tr>

            <tr>
                <td>A</td>
                <td><input type="checkbox" class="seats" value="A1"></td>
                <td><input type="checkbox" class="seats" value="A2"></td>
                <td><input type="checkbox" class="seats" value="A3"></td>
                <td><input type="checkbox" class="seats" value="A4"></td>
                <td><input type="checkbox" class="seats" value="A5"></td>
                <td class="seatGap"></td>
                <td><input type="checkbox" class="seats" value="A6"></td>
                <td><input type="checkbox" class="seats" value="A7"></td>
                <td><input type="checkbox" class="seats" value="A8"></td>
                <td><input type="checkbox" class="seats" value="A9"></td>
                <td><input type="checkbox" class="seats" value="A10"></td>
                <td><input type="checkbox" class="seats" value="A11"></td>
                <td><input type="checkbox" class="seats" value="A12"></td>
            </tr>

            <tr>
                <td>B</td>
                <td><input type="checkbox" class="seats" value="B1"></td>
                <td><input type="checkbox" class="seats" value="B2"></td>
                <td><input type="checkbox" class="seats" value="B3"></td>
                <td><input type="checkbox" class="seats" value="B4"></td>
                <td><input type="checkbox" class="seats" value="B5"></td>
                <td></td>
                <td><input type="checkbox" class="seats" value="B6"></td>
                <td><input type="checkbox" class="seats" value="B7"></td>
                <td><input type="checkbox" class="seats" value="B8"></td>
                <td><input type="checkbox" class="seats" value="B9"></td>
                <td><input type="checkbox" class="seats" value="B10"></td>
                <td><input type="checkbox" class="seats" value="B11"></td>
                <td><input type="checkbox" class="seats" value="B12"></td>
            </tr>

            <tr>
                <td>C</td>
                <td><input type="checkbox" class="seats" value="C1"></td>
                <td><input type="checkbox" class="seats" value="C2"></td>
                <td><input type="checkbox" class="seats" value="C3"></td>
                <td><input type="checkbox" class="seats" value="C4"></td>
                <td><input type="checkbox" class="seats" value="C5"></td>
                <td></td>
                <td><input type="checkbox" class="seats" value="C6"></td>
                <td><input type="checkbox" class="seats" value="C7"></td>
                <td><input type="checkbox" class="seats" value="C8"></td>
                <td><input type="checkbox" class="seats" value="C9"></td>
                <td><input type="checkbox" class="seats" value="C10"></td>
                <td><input type="checkbox" class="seats" value="C11"></td>
                <td><input type="checkbox" class="seats" value="C12"></td>
            </tr>

            <tr class="seatVGap"></tr>

            <tr>
                <td>D</td>
                <td><input type="checkbox" class="seats" value="D1"></td>
                <td><input type="checkbox" class="seats" value="D2"></td>
                <td><input type="checkbox" class="seats" value="D3"></td>
                <td><input type="checkbox" class="seats" value="D4"></td>
                <td><input type="checkbox" class="seats" value="D5"></td>
                <td></td>
                <td><input type="checkbox" class="seats" value="D6"></td>
                <td><input type="checkbox" class="seats" value="D7"></td>
                <td><input type="checkbox" class="seats" value="D8"></td>
                <td><input type="checkbox" class="seats" value="D9"></td>
                <td><input type="checkbox" class="seats" value="D10"></td>
                <td><input type="checkbox" class="seats" value="D11"></td>
                <td><input type="checkbox" class="seats" value="D12"></td>
            </tr>

            <tr>
                <td>E</td>
                <td><input type="checkbox" class="seats" value="E1"></td>
                <td><input type="checkbox" class="seats" value="E2"></td>
                <td><input type="checkbox" class="seats" value="E3"></td>
                <td><input type="checkbox" class="seats" value="E4"></td>
                <td><input type="checkbox" class="seats" value="E5"></td>
                <td></td>
                <td><input type="checkbox" class="seats" value="E6"></td>
                <td><input type="checkbox" class="seats" value="E7"></td>
                <td><input type="checkbox" class="seats" value="E8"></td>
                <td><input type="checkbox" class="seats" value="E9"></td>
                <td><input type="checkbox" class="seats" value="E10"></td>
                <td><input type="checkbox" class="seats" value="E11"></td>
                <td><input type="checkbox" class="seats" value="E12"></td>
            </tr>



            <tr>
                <td>F</td>
                <td><input type="checkbox" class="seats" value="F1"></td>
                <td><input type="checkbox" class="seats" value="F2"></td>
                <td><input type="checkbox" class="seats" value="F3"></td>
                <td><input type="checkbox" class="seats" value="F4"></td>
                <td><input type="checkbox" class="seats" value="F5"></td>
                <td></td>
                <td><input type="checkbox" class="seats" value="F6"></td>
                <td><input type="checkbox" class="seats" value="F7"></td>
                <td><input type="checkbox" class="seats" value="F8"></td>
                <td><input type="checkbox" class="seats" value="F9"></td>
                <td><input type="checkbox" class="seats" value="F10"></td>
                <td><input type="checkbox" class="seats" value="F11"></td>
                <td><input type="checkbox" class="seats" value="F12"></td>
            </tr>

        </table>

        <br /><button onclick="addTickets()">Confirmar Seleccion</button>
    </center>
</div>

<br /><br />

<div class="displayerBoxes">
    <center>
        <table class="Displaytable">
            <tr>
                <th>Nombre</th>
                <th>Numero de asientos</th>
                <th>Asientos</th>
            </tr>
            <tr>
                <td><textarea id="nameDisplay"></textarea></td>
                <td><textarea id="NumberDisplay"></textarea></td>
                <td><textarea id="seatsDisplay"></textarea></td>
            </tr>
        </table>
    </center>
</div>
</body>
<script>
    function onLoaderFunc() {
        $(".seatStructure *").prop("disabled", true);
        $(".displayerBoxes *").prop("disabled", true);
        getTickets();
    }

    function populateTable(tickets){
        tickets.forEach(t => {
            Taken(t);
        });
    }

    function Taken(t){
        var asiento;
        asiento = getLetter(t.row)+t.col;
        $('.seats').filter(function(){return this.value==asiento}).prop("id", "taken");
        $('.seats').filter(function(){return this.value==asiento}).prop("disabled", true);
    }

    function takeData() {
        if ($("#Username").val().length == 0 || $("#Numseats").val().length == 0) {
            alert("Favor de ingresar su nombre y la cantidad de asientos.");
        } else {
            $(".inputForm *").prop("disabled", true);
            $(".seatStructure *").prop("disabled", false);
            document.getElementById("notification").innerHTML =
                "<b style='margin-bottom:0px;background:yellow;'>Seleccione los asientos!</b>";
        }
    }

    function updateTextArea() {
        if ($("input:checked").length == $("#Numseats").val()) {
            $(".seatStructure *").prop("disabled", true);

            var allNameVals = [];
            var allNumberVals = [];
            var allSeatsVals = [];
            var alltickets = [];
            //Storing in Array
            allNameVals.push($("#Username").val());
            allNumberVals.push($("#Numseats").val());
            $("#seatsBlock :checked").each(function () {
                allSeatsVals.push($(this).val());
            });

            for(let i = 0; i < allSeatsVals.length; i++){
                let ticket = {
                    row : getrow(allSeatsVals[i]),
                    col : allSeatsVals[i].substring(1),
                    reservation : {id:1},
                    flight : {id:1}
                }

                alltickets.push(ticket);
            }



            //Displaying
            $("#nameDisplay").val(allNameVals);
            $("#NumberDisplay").val(allNumberVals);
            $("#seatsDisplay").val(allSeatsVals);

            return alltickets;
        } else {
            alert("Favor de seleccionar " + $("#Numseats").val() + " asientos");
        }
    }


    async function getTickets(){
        let userId = sessionStorage.getItem("userId");
        let Flight = {
            id : sessionStorage.getItem("flightId")
        }
        let requestBody = {
            method: "POST",
            body: JSON.stringify(Flight),
            headers: {'Content-Type': 'application/json'}
        }
        let response = await fetch("http://localhost:9393/get-tickets-flight", requestBody);
        let tickets = await response.json()
        console.log(tickets);
        populateTable(tickets);


    }
    async function addTickets(){
        let userId = sessionStorage.getItem("userId");
        let seats=2;
        let price=1500;
        let requestBody = {
            method: "POST",
            body: JSON.stringify(updateTextArea()),
            headers: {'Content-Type': 'application/json'}
        }
        let url = "http://localhost:9393/add-tickets"+"?id="+userId+"&seats="+seats+"&price="+price;
        let response = await fetch(url, requestBody);
        let tickets = await response.json()
        console.log(tickets);
        listTickets(tickets);


    }

    function myFunction() {
        alert($("input:checked").length);
    }

    function getrow(seats){
        switch(seats.substring(0,1)){
            case 'A':
                return 1;
                break;
            case 'B':
                return 2;
                break;
            case 'C':
                return 3;
                break;
            case 'D':
                return 4;
                break;
            case 'E':
                return 5;
                break;
            case 'F':
                return 6;
                break;

        }

    }

    function getLetter(seats){
        switch(seats){
            case 1:
                return 'A';
                break;
            case 2:
                return 'B';
                break;
            case 3:
                return 'C';
                break;
            case 4:
                return 'D';
                break;
            case 5:
                return 'E';
                break;
            case 6:
                return 'F';
                break;

        }

    }

    $(":checkbox").click(function () {
        if ($("input:checked").length == $("#Numseats").val()) {
            $(":checkbox").prop("disabled", true);
            $(":checked").prop("disabled", false);
        } else {
            $(":checkbox").prop("disabled", false);
        }
    });

    $(onLoaderFunc);
</script>
</html>